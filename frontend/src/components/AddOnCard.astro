---
import QuantitySelector from './QuantitySelector.astro';

interface Variant {
  id: string;
  name: string;
  price_modifier: number;
  available: boolean;
}

interface Props {
  id: string;
  name: string;
  description: string;
  price: number;
  imageUrl: string;
  quantity: number;
  requiresTicketType?: string;
  hasError?: boolean;
  variants?: Variant[];
  variantDisplay?: 'buttons' | 'dropdown';
  selectedVariant?: string;
}

const { 
  id, 
  name, 
  description, 
  price, 
  imageUrl, 
  quantity, 
  requiresTicketType, 
  hasError = false,
  variants = [],
  variantDisplay = 'buttons',
  selectedVariant
} = Astro.props;

// Truncate description to ~80 characters
const truncatedDescription = description.length > 80 
  ? description.slice(0, 80) + '...' 
  : description;

const hasVariants = variants && variants.length > 0;

// Calculate display price based on selected variant
const selectedVariantData = hasVariants && selectedVariant 
  ? variants.find(v => v.id === selectedVariant) 
  : null;
const displayPrice = selectedVariantData 
  ? price + selectedVariantData.price_modifier 
  : price;

// Format variant option text for dropdown
const formatVariantOption = (variant: Variant) => {
  let text = variant.name;
  if (variant.price_modifier > 0) {
    text += ` (+$${variant.price_modifier.toFixed(0)})`;
  } else if (variant.price_modifier < 0) {
    text += ` (-$${Math.abs(variant.price_modifier).toFixed(0)})`;
  }
  return text;
};
---

<div 
  class="addon-card" 
  data-addon-id={id}
  data-requires-ticket={requiresTicketType || ''}
  data-has-variants={hasVariants ? 'true' : 'false'}
  data-variant-display={variantDisplay}
  class:list={[{ 'has-quantity': quantity > 0, 'has-error': hasError }]}
>
  <div class="addon-main">
    <div class="addon-info">
      <h4 class="addon-name">{name}</h4>
      <p class="addon-description">
        {truncatedDescription}
      </p>
      <button type="button" class="read-more-btn" data-description={description}>
        Read more
      </button>
    </div>
    <div class="addon-image">
      <img src={imageUrl} alt={name} loading="lazy" />
    </div>
  </div>

  {hasVariants && variantDisplay === 'buttons' && (
    <div class="addon-variants">
      <div class="variant-selector variant-buttons" data-addon-id={id}>
        {variants.map((variant) => (
          <button
            type="button"
            class:list={['variant-btn', { 'selected': selectedVariant === variant.id, 'unavailable': !variant.available }]}
            data-variant-id={variant.id}
            data-price-modifier={variant.price_modifier}
            disabled={!variant.available}
          >
            {variant.name}
            {variant.price_modifier > 0 && (
              <span class="variant-modifier">+${variant.price_modifier.toFixed(0)}</span>
            )}
          </button>
        ))}
      </div>
    </div>
  )}

  {hasVariants && variantDisplay === 'dropdown' && (
    <div class="addon-variants">
      <div class="variant-selector variant-dropdown" data-addon-id={id}>
        <select class="variant-select" data-addon-id={id}>
          <option value="" disabled selected>Select an option</option>
          {variants.map((variant) => (
            <option 
              value={variant.id} 
              data-price-modifier={variant.price_modifier}
              disabled={!variant.available}
            >
              {formatVariantOption(variant)}{!variant.available ? ' (Sold out)' : ''}
            </option>
          ))}
        </select>
        <div class="select-arrow">
          <svg width="12" height="8" viewBox="0 0 12 8" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>
  )}

  <div class="addon-footer">
    <p class="addon-price">
      Add for <strong>${displayPrice.toFixed(2)}</strong>
    </p>
    <div class="addon-quantity">
      <QuantitySelector id={`addon-${id}`} value={quantity} />
    </div>
  </div>
</div>

<style>
  .addon-card {
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-white);
    overflow: hidden;
    transition: border-color 0.2s ease;
  }

  .addon-card.has-quantity {
    border-color: var(--border-color-active);
  }

  .addon-card.has-error {
    border-color: var(--fever-red);
  }

  .addon-main {
    display: flex;
    padding: 16px;
    gap: 16px;
  }

  .addon-info {
    flex: 1;
    min-width: 0;
  }

  .addon-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .addon-description {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 4px;
  }

  .read-more-btn {
    background: none;
    border: none;
    color: var(--fever-blue);
    font-size: 14px;
    font-weight: 500;
    padding: 0;
    cursor: pointer;
  }

  .read-more-btn:hover {
    text-decoration: underline;
  }

  .addon-image {
    flex-shrink: 0;
    width: 90px;
    height: 90px;
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .addon-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Variant selector styles */
  .addon-variants {
    padding: 0 16px 16px;
  }

  /* Button variant styles */
  .variant-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .variant-btn {
    padding: 8px 14px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    background: var(--bg-white);
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .variant-btn:hover:not(:disabled) {
    border-color: var(--fever-blue);
    background: var(--fever-blue-light);
  }

  .variant-btn.selected {
    border-color: var(--fever-blue);
    background: var(--fever-blue);
    color: white;
  }

  .variant-btn.unavailable {
    opacity: 0.4;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  .variant-modifier {
    font-size: 11px;
    opacity: 0.8;
  }

  .variant-btn.selected .variant-modifier {
    opacity: 1;
  }

  /* Dropdown variant styles */
  .variant-dropdown {
    position: relative;
    width: 100%;
  }

  .variant-select {
    width: 100%;
    padding: 12px 40px 12px 14px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-white);
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    transition: border-color 0.15s ease;
  }

  .variant-select:hover {
    border-color: var(--fever-blue);
  }

  .variant-select:focus {
    outline: none;
    border-color: var(--fever-blue);
    box-shadow: 0 0 0 3px var(--fever-blue-light);
  }

  .variant-select option:disabled {
    color: var(--text-muted);
  }

  .select-arrow {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: var(--text-secondary);
  }

  .addon-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-gray);
  }

  .addon-price {
    font-size: 14px;
    color: var(--text-primary);
  }

  .addon-price strong {
    font-weight: 700;
  }
</style>
