---
import QuantitySelector from './QuantitySelector.astro';

interface Variant {
  id: string;
  name: string;
  price_modifier: number;
  available: boolean;
}

interface Props {
  id: string;
  name: string;
  description: string;
  price: number;
  imageUrl: string;
  quantity: number;
  requiresTicketType?: string;
  hasError?: boolean;
  variants?: Variant[];
  selectedVariant?: string;
}

const { 
  id, 
  name, 
  description, 
  price, 
  imageUrl, 
  quantity, 
  requiresTicketType, 
  hasError = false,
  variants = [],
  selectedVariant
} = Astro.props;

// Truncate description to ~80 characters
const truncatedDescription = description.length > 80 
  ? description.slice(0, 80) + '...' 
  : description;

const hasVariants = variants && variants.length > 0;

// Calculate display price based on selected variant
const selectedVariantData = hasVariants && selectedVariant 
  ? variants.find(v => v.id === selectedVariant) 
  : null;
const displayPrice = selectedVariantData 
  ? price + selectedVariantData.price_modifier 
  : price;
---

<div 
  class="addon-card" 
  data-addon-id={id}
  data-requires-ticket={requiresTicketType || ''}
  data-has-variants={hasVariants ? 'true' : 'false'}
  class:list={[{ 'has-quantity': quantity > 0, 'has-error': hasError }]}
>
  <div class="addon-main">
    <div class="addon-info">
      <h4 class="addon-name">{name}</h4>
      <p class="addon-description">
        {truncatedDescription}
      </p>
      <button type="button" class="read-more-btn" data-description={description}>
        Read more
      </button>
    </div>
    <div class="addon-image">
      <img src={imageUrl} alt={name} loading="lazy" />
    </div>
  </div>

  {hasVariants && (
    <div class="addon-variants">
      <div class="variant-selector" data-addon-id={id}>
        {variants.map((variant) => (
          <button
            type="button"
            class:list={['variant-btn', { 'selected': selectedVariant === variant.id, 'unavailable': !variant.available }]}
            data-variant-id={variant.id}
            data-price-modifier={variant.price_modifier}
            disabled={!variant.available}
          >
            {variant.name}
            {variant.price_modifier > 0 && (
              <span class="variant-modifier">+${variant.price_modifier.toFixed(0)}</span>
            )}
          </button>
        ))}
      </div>
    </div>
  )}

  <div class="addon-footer">
    <p class="addon-price">
      Add for <strong>${displayPrice.toFixed(2)}</strong>
    </p>
    <div class="addon-quantity">
      <QuantitySelector id={`addon-${id}`} value={quantity} />
    </div>
  </div>
</div>

<style>
  .addon-card {
    border: 2px solid var(--border-color);
    border-radius: var(--radius-md);
    background: var(--bg-white);
    overflow: hidden;
    transition: border-color 0.2s ease;
  }

  .addon-card.has-quantity {
    border-color: var(--border-color-active);
  }

  .addon-card.has-error {
    border-color: var(--fever-red);
  }

  .addon-main {
    display: flex;
    padding: 16px;
    gap: 16px;
  }

  .addon-info {
    flex: 1;
    min-width: 0;
  }

  .addon-name {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
  }

  .addon-description {
    font-size: 14px;
    color: var(--text-secondary);
    line-height: 1.5;
    margin-bottom: 4px;
  }

  .read-more-btn {
    background: none;
    border: none;
    color: var(--fever-blue);
    font-size: 14px;
    font-weight: 500;
    padding: 0;
    cursor: pointer;
  }

  .read-more-btn:hover {
    text-decoration: underline;
  }

  .addon-image {
    flex-shrink: 0;
    width: 90px;
    height: 90px;
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .addon-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Variant selector styles */
  .addon-variants {
    padding: 0 16px 16px;
  }

  .variant-selector {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .variant-btn {
    padding: 8px 14px;
    border: 2px solid var(--border-color);
    border-radius: var(--radius-full);
    background: var(--bg-white);
    font-size: 13px;
    font-weight: 500;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .variant-btn:hover:not(:disabled) {
    border-color: var(--fever-blue);
    background: var(--fever-blue-light);
  }

  .variant-btn.selected {
    border-color: var(--fever-blue);
    background: var(--fever-blue);
    color: white;
  }

  .variant-btn.unavailable {
    opacity: 0.4;
    cursor: not-allowed;
    text-decoration: line-through;
  }

  .variant-modifier {
    font-size: 11px;
    opacity: 0.8;
  }

  .variant-btn.selected .variant-modifier {
    opacity: 1;
  }

  .addon-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-gray);
  }

  .addon-price {
    font-size: 14px;
    color: var(--text-primary);
  }

  .addon-price strong {
    font-weight: 700;
  }
</style>
